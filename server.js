const express = require ('express');
const app = express ();
const server = require ('http').Server (app);
const bodyParser = require ('body-parser');

// For parsing JSON
app.use (bodyParser.json ());

app.use (function (req, res, next) {
  res.header ('Access-Control-Allow-Origin', '*');
  res.header (
    'Access-Control-Allow-Headers',
    'Origin, X-Requested-With, Content-Type, Accept'
  );
  next ();
});

var c1 = {
  '50': {
    '69': 81.1,
    '70': 79.1,
    '71': 83.5,
    '73': 95.5,
    '74': 98.8,
    '145': 84,
    '146': 79.1,
    '148': 83.5,
    '149': 80.3,
    '150': 94.1,
    '319': 78.6,
    '320': 83.6,
    '321': 83.8,
    '322': 86,
    '323': 84.5,
    '324': 94,
    '325': 99.8,
    '346': 80.1,
    '347': 95.3,
    '348': 86.5,
    '349': 99.9,
  },
  '51': {
    '52': 85.5,
    '53': 93.7,
    '54': 89,
    '55': 85.5,
    '56': 91.1,
    '58': 82.2,
    '59': 76.1,
    '60': 80.8,
    '61': 94.1,
    '62': 78.3,
    '63': 85.8,
    '66': 92.4,
    '67': 95.4,
    '68': 99.7,
    '130': 87.9,
    '131': 98.7,
    '132': 87.2,
    '133': 90.9,
    '134': 77.8,
    '135': 98.8,
    '136': 95.5,
    '137': 79.3,
    '138': 93.9,
    '139': 76.7,
    '140': 95.5,
    '141': 94.9,
    '142': 93.8,
    '143': 94.5,
    '152': 95.6,
    '153': 93.6,
    '154': 95.5,
    '155': 85.6,
    '156': 85.4,
    '157': 95.2,
    '307': 95.1,
    '309': 92.1,
    '310': 91.1,
    '311': 95.7,
    '312': 87.1,
    '313': 95.6,
    '314': 78.4,
    '315': 95,
    '316': 87.9,
    '317': 98.7,
    '318': 92.1,
    '326': 79,
    '327': 88.5,
    '328': 93.2,
    '330': 78,
    '332': 95.5,
    '333': 94.6,
    '334': 94.1,
    '335': 86.6,
    '336': 89,
    '337': 86.1,
    '338': 93.1,
    '339': 95.1,
    '341': 91,
    '343': 95.5,
    '351': 89.9,
    '352': 84.6,
    '354': 96.7,
    '355': 95.5,
    '356': 94.2,
  },
  '57': {
    '64': 99.1,
    '65': 99.7,
    '151': 99.9,
    '308': 94.3,
    '329': 95.7,
    '331': 83.2,
    '340': 99.7,
    '342': 99.7,
    '353': 96.6,
  },
  '72': {
    '147': 86.8,
    '345': 86.1,
    '350': 92.7,
  },
  '144': {
    '344': 83.8,
  },
};

var c2 = {
  '75': {
    '94': 82.8,
    '95': 82.6,
    '96': 82.3,
    '97': 94.9,
    '98': 94.6,
    '99': 94.4,
    '100': 77.9,
    '270': 81.1,
    '271': 84.1,
    '273': 93.6,
    '274': 93.9,
    '275': 95.9,
    '296': 77.8,
    '297': 95.3,
    '298': 85.7,
    '299': 83.1,
    '300': 78.6,
  },
  '76': {
    '78': 96,
    '80': 84.1,
    '81': 79.5,
    '82': 96.3,
    '83': 91.5,
    '84': 90.2,
    '85': 95,
    '86': 88.2,
    '89': 88.3,
    '90': 94.4,
    '91': 94.5,
    '93': 87.5,
    '102': 97,
    '267': 94,
    '268': 93.7,
    '278': 96.5,
    '279': 95.3,
    '280': 93.5,
    '281': 86.3,
    '282': 81.7,
    '283': 91.5,
    '284': 76.9,
    '285': 86.5,
    '286': 93.5,
    '288': 92,
    '289': 77.8,
    '290': 77,
    '291': 92.5,
    '292': 88,
    '293': 76.4,
    '301': 80.6,
    '302': 83.8,
    '303': 96.9,
    '304': 95.7,
    '305': 78.3,
    '306': 86.6,
  },
  '77': {
    '79': 77.4,
    '87': 75.9,
    '88': 84.5,
    '92': 87,
    '101': 96.5,
    '276': 77.7,
    '277': 76.3,
    '287': 92.5,
  },
  '269': {'272': 84.1, '294': 90.5, '295': 99},
};

var c3 = {
  '50': {
    '69': 81.1,
    '70': 79.1,
    '71': 83.5,
    '73': 95.5,
    '74': 98.8,
    '145': 84,
    '146': 79.1,
    '148': 83.5,
    '149': 80.3,
    '150': 94.1,
    '319': 78.6,
    '320': 83.6,
    '321': 83.8,
    '322': 86,
    '323': 84.5,
    '324': 94,
    '325': 99.8,
    '346': 80.1,
    '347': 95.3,
    '348': 86.5,
    '349': 99.9,
  },
  '51': {
    '52': 85.5,
    '53': 93.7,
    '54': 89,
    '55': 85.5,
    '56': 91.1,
    '58': 82.2,
    '59': 76.1,
    '60': 80.8,
    '61': 94.1,
    '62': 78.3,
    '63': 85.8,
    '66': 92.4,
    '67': 95.4,
    '68': 99.7,
    '130': 87.9,
    '131': 98.7,
    '132': 87.2,
    '133': 90.9,
    '134': 77.8,
    '135': 98.8,
    '136': 95.5,
    '137': 79.3,
    '138': 93.9,
    '139': 76.7,
    '140': 95.5,
    '141': 94.9,
    '142': 93.8,
    '143': 94.5,
    '152': 95.6,
    '153': 93.6,
    '154': 95.5,
    '155': 85.6,
    '156': 85.4,
    '157': 95.2,
    '307': 95.1,
    '309': 92.1,
    '310': 91.1,
    '311': 95.7,
    '312': 87.1,
    '313': 95.6,
    '314': 78.4,
    '315': 95,
    '316': 87.9,
    '317': 98.7,
    '318': 92.1,
    '326': 79,
    '327': 88.5,
    '328': 93.2,
    '330': 78,
    '332': 95.5,
    '333': 94.6,
    '334': 94.1,
    '335': 86.6,
    '336': 89,
    '337': 86.1,
    '338': 93.1,
    '339': 95.1,
    '341': 91,
    '343': 95.5,
    '351': 89.9,
    '352': 84.6,
    '354': 96.7,
    '355': 95.5,
    '356': 94.2,
  },
  '57': {
    '64': 99.1,
    '65': 99.7,
    '151': 99.9,
    '308': 94.3,
    '329': 95.7,
    '331': 83.2,
    '340': 99.7,
    '342': 99.7,
    '353': 96.6,
  },
  '72': {'147': 86.8, '345': 86.1, '350': 92.7},
  '144': {'344': 83.8},
};
var c4 = {
  '1': {
    '2': 85.6,
    '3': 75.1,
    '4': 97.5,
    '5': 83.5,
    '6': 93.7,
    '7': 99,
    '8': 75.2,
    '9': 100,
    '11': 87.2,
    '12': 96.2,
    '13': 83.3,
    '14': 98.1,
    '15': 92.6,
    '16': 91.2,
    '17': 97.7,
    '18': 97.2,
    '26': 99.2,
    '27': 90,
    '28': 83.7,
    '29': 98.7,
    '30': 81.8,
    '31': 95.7,
    '32': 96.2,
    '33': 99.4,
    '34': 93.7,
    '35': 99.2,
    '36': 89.7,
    '38': 98.6,
    '40': 98.7,
    '41': 96.7,
    '43': 83.7,
    '105': 97.9,
    '107': 97.2,
    '110': 99.5,
    '111': 98.8,
    '113': 100,
    '114': 92.7,
    '115': 95.9,
    '116': 98.6,
    '118': 97.2,
    '126': 99.1,
    '128': 99.7,
    '129': 91.5,
    '226': 99.8,
    '228': 75.2,
    '229': 95.9,
    '230': 90,
    '231': 94.7,
    '232': 93.2,
    '233': 98,
    '234': 95.7,
    '235': 92.2,
    '237': 83.6,
    '238': 89.3,
    '239': 95.3,
    '240': 95.4,
    '242': 81.9,
    '251': 96.2,
    '252': 96.5,
    '254': 75.1,
    '255': 85.2,
    '256': 99.3,
    '257': 77.2,
    '258': 98.2,
    '259': 96.2,
    '260': 95.2,
    '261': 89.6,
    '262': 82.9,
    '263': 86.4,
    '264': 83.4,
    '265': 98.7,
  },
  '10': {
    '37': 84.9,
    '39': 89,
    '42': 97.3,
    '103': 99.5,
    '104': 95.5,
    '106': 96.3,
    '108': 99.3,
    '109': 97.5,
    '112': 98.5,
    '117': 97.7,
    '127': 99.7,
    '227': 85.5,
    '236': 93.2,
    '241': 80.1,
    '243': 88.1,
    '253': 98.8,
    '266': 85.2,
  },
  '19': {
    '20': 81.7,
    '22': 83.3,
    '23': 83.7,
    '24': 83.2,
    '25': 83.2,
    '44': 93.2,
    '45': 79.7,
    '46': 91.1,
    '47': 87.6,
    '48': 81.5,
    '49': 81.6,
    '119': 83.6,
    '120': 93.1,
    '121': 81.2,
    '122': 80.7,
    '123': 82.4,
    '124': 82.2,
    '125': 83.3,
    '225': 83.8,
    '244': 81.5,
    '245': 89.6,
    '246': 81.8,
    '247': 82.2,
    '249': 81.5,
    '250': 76.5,
  },
};
function prepareData (cluster) {
  var nodes = Object.keys (cluster).reduce ((a, c) => {
    const groupNodes = Object.keys (cluster[c]).map (p => ({
      id: Number (p),
      group: Number (c),
    }));
    return [...a, ...groupNodes, {id: Number (c), group: Number (c)}];
  }, []);

  var links = Object.keys (cluster).reduce ((a, c) => {
    const groupLinks = Object.keys (cluster[c]).map (p => ({
      source: Number (p),
      target: Number (c),
      value: cluster[c][p],
    }));
    return [...a, ...groupLinks];
  }, []);

  links = [
    ...links,
    ...Object.keys (cluster).map ((c, i, arr) => {
      if (i + 1 < arr.length) {
        return {
          source: Number (c),
          value: 80,
          target: Number (arr[i + 1]),
        };
      } else {
        return {
          source: Number (c),
          value: 80,
          target: Number (arr[0]),
        };
      }
    }),
  ];
  return [nodes, links];
}
const graphData = {
  cluster1: {
    nodes: prepareData (c1)[0],
    links: prepareData (c1)[1],
    color: 'rgb(190, 174, 212)',
  },
  cluster2: {
    nodes: prepareData (c2)[0],
    links: prepareData (c2)[1],
    color: 'rgb(253, 192, 134)',
  },
  cluster3: {
    nodes: prepareData (c3)[0],
    links: prepareData (c3)[1],
    color: 'rgb(127, 201, 127)',
  },
  cluster4: {
    nodes: prepareData (c4)[0],
    links: prepareData (c4)[1],
    color: 'rgb(56, 108, 176)',
  },
};

app.get ('/cluster/graph', (req, res) => {
  // res.set ('Access-Control-Allow-Origin', '*');
  const data = graphData;
  res.send (JSON.stringify (data));
});

const pointData = {
  cluster1: {'57': 60.1, '72': 40.4, '144': 43.6, '50': 38.1, '51': 80.7},
};
app.post ('/car/insurance', (req, res) => {
  console.log (req.body);
  // res.set ('Access-Control-Allow-Origin', '*');
  const data = pointData;
  res.send (JSON.stringify (data));
});

// Start the server
server.listen (8000, () => console.log ('Server is running!'));
